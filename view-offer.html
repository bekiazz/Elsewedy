<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offer Details ‚Äì Elsewedy Electric</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-logo">
      <div class="company-name">ELSEWEDY</div>
      <div class="line"></div>
      <div class="slogan">ELECTRIC</div>
      <div class="accent-curve"></div>
    </div>
    <a href="dashboard.html" class="btn">‚Üê Back to Dashboard</a>
  </header>

  <main>
    <div class="container" id="offerDetails">
      <h2>Loading offer...</h2>
      <div id="debugInfo" style="background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px;">
        <strong>Debug Log:</strong>
        <div id="debugLog"></div>
      </div>
    </div>
  </main>

  <script type="module">
    // Import Firebase modules at the top level
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    
    const debugLog = document.getElementById('debugLog');
    function log(msg) {
      console.log(msg);
      debugLog.innerHTML += `<br>${msg}`;
    }
    
    // Get offer ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const offerId = urlParams.get('id');
    
    log(`Step 1: Offer ID = ${offerId}`);
    
    if (!offerId) {
      document.getElementById('offerDetails').innerHTML = `
        <div class="message message-error">
          <h3>‚ùå No offer ID provided</h3>
          <p>URL: ${window.location.href}</p>
          <p>Please select an offer from the dashboard.</p>
          <a href="dashboard.html" class="btn">Return to Dashboard</a>
        </div>
      `;
    } else {
      // Check authentication and load offer
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          log("Step 2: No user - redirecting to login");
          window.location.href = "index.html";
          return;
        }
        
        log(`Step 2: User authenticated: ${user.email}`);
        
        try {
          // Load offer from Firestore
          log(`Step 3: Fetching document offers/${offerId}`);
          const docRef = doc(db, "offers", offerId);
          const docSnap = await getDoc(docRef);
          
          log(`Step 4: Document exists: ${docSnap.exists()}`);
          
          if (!docSnap.exists()) {
            document.getElementById('offerDetails').innerHTML = `
              <div class="message message-error">
                <h3>‚ùå Offer Not Found</h3>
                <p>Offer ID: ${offerId}</p>
                <p>The offer doesn't exist in the database.</p>
                <a href="dashboard.html" class="btn">Return to Dashboard</a>
              </div>
            `;
            return;
          }
          
          const d = docSnap.data();
          log(`Step 5: Data loaded - Project: ${d.projectName}`);
          log(`Step 6: Raw data: ${JSON.stringify(d, null, 2)}`);
          
          // Helper function to format dates safely
          function formatDate(dateField) {
            if (!dateField) return 'N/A';
            
            // Check if it's a Firestore Timestamp
            if (dateField.toDate && typeof dateField.toDate === 'function') {
              return dateField.toDate().toLocaleDateString();
            }
            
            // Check if it's already a Date object
            if (dateField instanceof Date) {
              return dateField.toLocaleDateString();
            }
            
            // Try to parse as string
            try {
              return new Date(dateField).toLocaleDateString();
            } catch (e) {
              return 'Invalid Date';
            }
          }
          
          // Format dates
          const startDate = formatDate(d.startDate);
          const expiryDate = formatDate(d.expiryDate);
          const deliveryDate = formatDate(d.deliveryDate);
          const createdAt = formatDate(d.createdAt);
          const sentAt = d.sentAt ? formatDate(d.sentAt) : 'Not sent yet';
          
          // Format value
          const value = d.value ? "$" + d.value.toLocaleString() : 'N/A';
          
          // Status badge
          const statusClass = d.status === "sent" ? "sent" : "pending";
          
          log("Step 7: Rendering HTML...");
          
          // Display the offer
          document.getElementById('offerDetails').innerHTML = `
            <h2>${d.projectName || 'Unnamed Project'}</h2>
            
            <div class="form-row">
              <div class="form-group">
                <label>Status</label>
                <div class="status-display">
                  <span class="status ${statusClass}">${d.status || 'pending'}</span>
                </div>
              </div>
              <div class="form-group">
                <label>Value</label>
                <div class="status-display">${value}</div>
              </div>
              <div class="form-group">
                <label>Probability</label>
                <div class="status-display">${d.probability || 0}%</div>
              </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Company Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Company Name</label>
                <div class="status-display">${d.company || 'N/A'}</div>
              </div>
              <div class="form-group">
                <label>Buyer Name</label>
                <div class="status-display">${d.buyer || 'N/A'}</div>
              </div>
              <div class="form-group">
                <label>Package Code</label>
                <div class="status-display">${d.customerPackageCode || 'N/A'}</div>
              </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Contact Details</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Email</label>
                <div class="status-display">${d.contacts?.email || 'N/A'}</div>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <div class="status-display">${d.contacts?.phone || 'N/A'}</div>
              </div>
              <div class="form-group">
                <label>Factory</label>
                <div class="status-display">${d.factory || 'N/A'}</div>
              </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Project Details</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Product</label>
                <div class="status-display">${d.product || 'N/A'}</div>
              </div>
              <div class="form-group">
                <label>Start Date</label>
                <div class="status-display">${startDate}</div>
              </div>
              <div class="form-group">
                <label>Expiry Date</label>
                <div class="status-display">${expiryDate}</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Delivery Date</label>
                <div class="status-display">${deliveryDate}</div>
              </div>
              <div class="form-group">
                <label>Created At</label>
                <div class="status-display">${createdAt}</div>
              </div>
              <div class="form-group">
                <label>Sent At</label>
                <div class="status-display">${sentAt}</div>
              </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Description</h3>
            <div class="status-display" style="white-space: pre-wrap;">${d.description || 'No description provided'}</div>

            ${d.comment ? `
              <h3 style="margin-top: 30px; margin-bottom: 15px;">Comments</h3>
              <div class="status-display" style="white-space: pre-wrap;">${d.comment}</div>
              ${d.commentStatus ? `<p><strong>Comment Status:</strong> ${d.commentStatus}</p>` : ''}
            ` : ''}

            <div style="margin-top: 30px; display: flex; gap: 10px;">
              <a href="dashboard.html" class="btn">‚Üê Back to Dashboard</a>
              ${d.status === "pending" ? `
                <button class="btn" onclick="markAsSent('${offerId}')">üì§ Mark as Sent</button>
              ` : ''}
            </div>

            <details style="margin-top: 30px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
              <summary style="cursor: pointer; font-weight: bold;">üîç Debug Info (Click to expand)</summary>
              <pre style="margin-top: 10px; overflow-x: auto; font-size: 11px;">${JSON.stringify(d, null, 2)}</pre>
            </details>
          `;
          
          log("‚úÖ Step 8: Offer displayed successfully!");
          
        } catch (error) {
          console.error("Error loading offer:", error);
          log(`‚ùå ERROR: ${error.message}`);
          document.getElementById('offerDetails').innerHTML = `
            <div class="message message-error">
              <h3>‚ùå Error Loading Offer</h3>
              <p><strong>Error:</strong> ${error.message}</p>
              <p><strong>Error Type:</strong> ${error.name}</p>
              <p><strong>Stack:</strong> <code style="font-size: 11px;">${error.stack}</code></p>
              <a href="dashboard.html" class="btn">Return to Dashboard</a>
            </div>
          `;
        }
      });
    }

    // Function to mark offer as sent
    window.markAsSent = async function(id) {
      if (!confirm("Mark this offer as SENT?")) return;
      
      try {
        const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");
        await updateDoc(doc(db, "offers", id), {
          status: "sent",
          sentAt: new Date()
        });
        alert("‚úÖ Offer marked as sent!");
        location.reload();
      } catch (error) {
        alert("‚ùå Error: " + error.message);
      }
    };
  </script>
</body>
</html>
