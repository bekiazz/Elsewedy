<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offer Details – Elsewedy Electric</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-logo">
      <div class="company-name">ELSEWEDY</div>
      <div class="line"></div>
      <div class="slogan">ELECTRIC</div>
      <div class="accent-curve"></div>
    </div>
    <a href="dashboard.html" class="btn">← Back</a>
  </header>

  <main>
    <div class="container" id="offerDetails">
      <h2>Loading offer...</h2>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Redirect to login if not authenticated
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html"; // ✅ Fixed: was "login.html"
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const offerId = urlParams.get('id');
    const container = document.getElementById('offerDetails');

    if (!offerId) {
      container.innerHTML = "<p class='message message-error'>❌ No offer ID provided.</p>";
      return;
    }

    async function loadOffer() {
      try {
        const docRef = doc(db, "offers", offerId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          container.innerHTML = "<p class='message message-error'>Offer not found.</p>";
          return;
        }

        const d = docSnap.data();
        const formatDate = (firestoreDate) => {
          if (!firestoreDate) return 'N/A';
          // Handle both Timestamp and JS Date
          const date = firestoreDate.toDate ? firestoreDate.toDate() : new Date(firestoreDate);
          return date.toLocaleDateString();
        };
        const formatCurrency = (val) => val ? "$" + Number(val).toLocaleString() : "N/A";

        container.innerHTML = `
          <h2>${escapeHtml(d.projectName || 'N/A')}</h2>
          <div class="form-row">
            <div class="form-group"><strong>Product:</strong> ${escapeHtml(d.product || 'N/A')}</div>
            <div class="form-group"><strong>Value:</strong> ${formatCurrency(d.value)}</div>
            <div class="form-group"><strong>Status:</strong> 
              <span class="status ${d.status === 'sent' ? 'sent' : 'pending'}">
                ${d.status || 'pending'}
              </span>
            </div>
          </div>

          <h3>Company & Contact</h3>
          <div class="form-row">
            <div class="form-group"><strong>Company:</strong> ${escapeHtml(d.company || 'N/A')}</div>
            <div class="form-group"><strong>Buyer:</strong> ${escapeHtml(d.buyer || 'N/A')}</div>
            <div class="form-group"><strong>Package Code:</strong> ${escapeHtml(d.customerPackageCode || 'N/A')}</div>
            <div class="form-group"><strong>Email:</strong> ${escapeHtml(d.contacts?.email || 'N/A')}</div>
            <div class="form-group"><strong>Phone:</strong> ${escapeHtml(d.contacts?.phone || 'N/A')}</div>
          </div>

          <h3>Dates</h3>
          <div class="form-row">
            <div class="form-group"><strong>Start:</strong> ${formatDate(d.startDate)}</div>
            <div class="form-group"><strong>Expiry:</strong> ${formatDate(d.expiryDate)}</div>
            <div class="form-group"><strong>Delivery:</strong> ${formatDate(d.deliveryDate)}</div>
            ${d.status === 'sent' ? `<div class="form-group"><strong>Sent On:</strong> ${formatDate(d.sentAt)}</div>` : ''}
          </div>

          <h3>Additional Info</h3>
          <div class="form-group full-width"><strong>Factory:</strong> ${escapeHtml(d.factory || 'N/A')}</div>
          <div class="form-group full-width"><strong>Probability:</strong> ${d.probability || 0}%</div>
          <div class="form-group full-width"><strong>Comment Status:</strong> ${escapeHtml(d.commentStatus || 'N/A')}</div>
          <div class="form-group full-width"><strong>Comment:</strong> ${escapeHtml(d.comment || '') || '—'}</div>

          <h3>Description</h3>
          <div class="form-group full-width">${escapeHtml(d.description || '').replace(/\n/g, '<br>')}</div>
        `;
      } catch (error) {
        console.error("View Offer Error:", error);
        container.innerHTML = `<p class="message message-error">❌ Failed to load offer: ${error.message}</p>`;
      }
    }

    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return String(unsafe);
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    loadOffer();
  </script>
</body>
</html>