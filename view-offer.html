<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offer Details – Elsewedy Electric</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-logo">
      <div class="company-name">ELSEWEDY</div>
      <div class="line"></div>
      <div class="slogan">ELECTRIC</div>
      <div class="accent-curve"></div>
    </div>
    <a href="dashboard.html" class="btn">← Back to Dashboard</a>
  </header>

  <main>
    <div class="container" id="offerDetails">
      <h2>Debugging Offer Loading...</h2>
      <div id="debugInfo" style="background: #f0f0f0; padding: 20px; margin: 10px 0; border-radius: 5px;">
        <p id="debugText">Initializing...</p>
      </div>
    </div>
  </main>

  <script type="module">
    // Debug element
    const debugText = document.getElementById('debugText');
    
    try {
      debugText.textContent = 'Step 1: Script started...';
      
      // Get offer ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const offerId = urlParams.get('id');
      debugText.textContent += `\nStep 2: Offer ID from URL: ${offerId || 'NOT FOUND'}`;
      
      if (!offerId) {
        document.getElementById('offerDetails').innerHTML = `
          <div class="message message-error">
            <h3>❌ No offer ID in URL</h3>
            <p>URL should be: offer.html?id=YOUR_OFFER_ID</p>
            <p>Current URL: ${window.location.href}</p>
            <a href="dashboard.html" class="btn">Return to Dashboard</a>
          </div>
        `;
        return;
      }
      
      debugText.textContent += '\nStep 3: Trying to import Firebase modules...';
      
      // Import Firebase
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
      
      debugText.textContent += '\nStep 4: Firebase modules imported, checking auth...';
      
      // Check authentication
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          debugText.textContent += '\nStep 5: User not authenticated, redirecting...';
          window.location.href = "index.html";
          return;
        }
        
        debugText.textContent += `\nStep 5: User authenticated (${user.email}), loading offer...`;
        
        try {
          // Load offer from Firestore
          const docRef = doc(db, "offers", offerId);
          debugText.textContent += `\nStep 6: Document reference created for offers/${offerId}`;
          
          const docSnap = await getDoc(docRef);
          debugText.textContent += `\nStep 7: Document fetched, exists: ${docSnap.exists()}`;
          
          if (!docSnap.exists()) {
            document.getElementById('offerDetails').innerHTML = `
              <div class="message message-error">
                <h3>❌ Offer Not Found</h3>
                <p>Offer ID: ${offerId}</p>
                <p>This offer doesn't exist in the database.</p>
                <a href="dashboard.html" class="btn">Return to Dashboard</a>
              </div>
            `;
            return;
          }
          
          const offerData = docSnap.data();
          debugText.textContent += `\nStep 8: Data loaded: ${offerData.projectName}`;
          
          // Display the offer
          document.getElementById('offerDetails').innerHTML = `
            <h2>${offerData.projectName || 'No Name'}</h2>
            <div class="form-row">
              <div class="form-group"><strong>Company:</strong> ${offerData.company || 'N/A'}</div>
              <div class="form-group"><strong>Status:</strong> ${offerData.status || 'pending'}</div>
            </div>
            <div class="form-row">
              <div class="form-group"><strong>Value:</strong> $${offerData.value || 'N/A'}</div>
              <div class="form-group"><strong>Buyer:</strong> ${offerData.buyer || 'N/A'}</div>
            </div>
            <p><strong>Description:</strong> ${offerData.description || 'No description'}</p>
            <p style="margin-top: 20px; color: green; font-weight: bold;">✅ Offer loaded successfully!</p>
          `;
          
        } catch (firestoreError) {
          debugText.textContent += `\nStep 6-8 ERROR: ${firestoreError.message}`;
          document.getElementById('offerDetails').innerHTML = `
            <div class="message message-error">
              <h3>❌ Firestore Error</h3>
              <p>${firestoreError.message}</p>
              <p>Check if Firebase is properly configured.</p>
            </div>
          `;
        }
      });
      
    } catch (importError) {
      debugText.textContent = `IMPORT ERROR: ${importError.message}`;
      document.getElementById('offerDetails').innerHTML = `
        <div class="message message-error">
          <h3>❌ Script Error</h3>
          <p>${importError.message}</p>
          <p>Check if firebase.js exists and has correct exports.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
